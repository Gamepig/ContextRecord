# 06_MCP Server

## 目標
實作 MCP Server 的核心功能，包括處理與客戶端的連接 (SSE) 和工具呼叫的架構 (概念性)。

## 細化步驟

### 6.1 連接功能 (SSE)

1.  [x] 研究 FastAPI 中實現 Server-Sent Events (SSE) 的方式。
    *   FastAPI 可以通過 `StreamingResponse` 或其他第三方庫來實現 SSE。
2.  [x] 創建處理 SSE 連線的 API 端點。
    *   在 `src/functions/` 目錄下的適當模組中 (例如 `server.py` 或 `events.py`)，定義 `GET /events/` 端點。
    *   該端點需要返回一個 `StreamingResponse`，其內容類型設置為 `text/event-stream`。
3.  [x] 實現一個機制來管理所有連接的客戶端。
    *   可以使用一個列表或集合來儲存客戶端的響應對象或生成器。
4.  [x] 設計一個事件發布/訂閱系統或簡單的通知機制。
    *   當有新對話紀錄儲存到資料庫時 (在步驟 5.1 的 API 中)，需要觸發一個事件。
    *   SSE 端點需要「訂閱」這些事件。
    *   事件觸發時，將格式化後的 SSE 訊息 (格式為 `data: ...\n\n`) 推送到所有已連接的客戶端。
    *   **考慮細節：** 使用非同步佇列 (如 `asyncio.Queue`) 還是其他方式來傳遞事件？如何處理客戶端斷開連線並從管理列表中移除？
5.  [x] 格式化要通過 SSE 推送的數據。
    *   將新創建的對話紀錄或其他相關資訊格式化為 SSE 規範要求的字符串格式。

### 6.2 工具呼叫 (概念性)

1.  [x] 初步規劃工具呼叫的架構。
    *   **考慮細節：**
        *   **工具註冊：** 如何定義和註冊不同的工具？工具的元數據 (名稱、描述、參數) 如何管理？
        *   **請求接收：** MCP Server 如何接收來自客戶端的工具呼叫請求？是通過獨立的 API 端點還是通過現有的 SSE 連線？
        *   **請求分派：** 如何根據請求識別要呼叫哪個已註冊的工具？
        *   **工具執行：** 如何異步執行工具？工具執行過程中的輸出如何處理？
        *   **結果返回：** 工具執行完成後的結果如何返回給客戶端？是通過 SSE 推送還是通過另一個 API 端點？
        *   **安全性：** 如何確保只有授權的客戶端可以觸發工具呼叫？如何限制工具可以執行的操作？
2.  [x] (可選) 為工具呼叫定義初步的請求和響應數據結構 (例如使用 Pydantic 模型)。
3.  [x] **(注意：** 這部分在簡易版本中主要集中在概念規劃，實際實作可能涉及複雜的設計，可以作為後續的重要擴展)** 

## 測試

在完成 SSE 連接功能後，需要為這部分撰寫單元測試或功能測試，以確保事件能正確地發送和接收。

1.  [x] **SSE 連接功能單元/功能測試：**
    *   測試 `/events/` 端點是否能成功建立 SSE 連接並返回 `text/event-stream` 內容類型。
    *   模擬發送事件 (例如，在對話紀錄 API 中觸發事件)，測試已連接的客戶端是否能收到正確格式 (data: ...\n\n) 的 SSE 訊息。
    *   測試多個客戶端同時連接時，事件是否能廣播到所有客戶端。
    *   測試客戶端斷開連線時，伺服器是否能正確處理並從活動連接列表中移除該客戶端。
    *   測試事件數據的格式化是否符合預期。

工具呼叫部分目前為概念性規劃，待實際開發實作後，再針對具體實現方式撰寫測試。 