# 07_撰寫測試

## 目標
為專案的核心功能編寫單元測試和整合測試，確保程式碼的正確性和穩定性，並將測試整合到 CI 工作流程中。

## 細化步驟

1.  [X] 選擇並設定測試框架。
    *   推薦使用 `pytest`，它是一個功能豐富且易於使用的 Python 測試框架。
2.  [X] 安裝測試框架及其相關依賴。
    *   執行命令：`uv install pytest pytest-asyncio` (如果使用異步代碼)
3.  [X] 建立測試目錄和測試檔案。
    *   在專案根目錄下創建一個 `tests/` 目錄。
    *   在 `tests/` 目錄下創建對應模組的測試檔案 (例如 `tests/test_conversations.py`)。
4.  [X] 為「紀錄對話」功能編寫單元測試。
    *   測試驗證輸入數據的邏輯。
    *   模擬資料庫操作，測試數據是否正確地被構建和傳遞給 ORM 模型。
    *   測試錯誤處理邏輯是否按預期工作。
    *   **注意：** 在測試檔案中導入應用程式模組時，請使用新的路徑結構 (例如 `from src.functions.conversations import ...`, `from src.database import ...`)。
5.  [X] 為「搜尋對話」功能編寫單元測試。
    *   測試構建資料庫查詢的邏輯。
    *   模擬資料庫返回不同的數據集，測試搜尋結果的過濾、排序和格式化是否正確。
    *   測試邊界情況 (例如空查詢、無匹配結果)。
    *   **注意：** 在測試檔案中導入應用程式模組時，請使用新的路徑結構。
6.  [X] 為 API 端點編寫整合測試。
    *   使用 `FastAPI.test_client` 或 `httpx` 等庫來發送 HTTP 請求到您的 API 端點。
    *   測試 `POST /conversations/` 端點是否能夠成功接收並儲存數據到資料庫。
    *   測試 `GET /search/` 端點是否能夠根據查詢參數返回正確的搜尋結果。
    *   **考慮細節：** 如何在整合測試中管理一個臨時的測試資料庫？可以使用 in-memory SQLite (雖然功能有限) 或專門為測試設定一個輕量級的 PostgreSQL 實例。
    *   **注意：** 在整合測試中設置 FastAPI 應用或導入 API 路由器時，請使用新的路徑結構 (例如 `from src.main import app`, `from src.functions.conversations import router`)。
7.  [X] 為 SSE 連接功能編寫測試 (可選但推薦)。
    *   測試客戶端是否能夠成功建立 SSE 連線。
    *   測試在事件觸發時，訊息是否正確地通過 SSE 推送給連接的客戶端。
    *   這部分測試可能比較複雜，需要模擬非同步事件流。
    *   **注意：** 在測試檔案中導入相關模組時，請使用新的路徑結構 (例如 `from src.functions.server import ...`)。
8.  [X] 將測試執行整合到 CI 工作流程中 (已在步驟 3 中規劃，這裡再次強調)。
    *   確保每次提交都能自動運行所有測試，並在測試失敗時阻止合併。
9.  [X] 定期運行測試並根據需要更新測試。 